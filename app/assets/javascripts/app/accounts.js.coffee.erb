app = angular.module 'accounts', []

app.controller 'AccountsController', ['$http', ($http) ->
  _self = this
  @accounts = []
  @displayRecords = []

  $http.get("/entities/14/accounts.json").success (data) ->
    _self.accounts = data
    types = ['Asset', 'Liability', 'Equity', 'Income', 'Expense']
    groupedAccounts = _.groupBy data, 'account_type'
    _self.displayRecords = _.chain(types).reduce( (list, type) ->
      # Calculate the summary header
      typedAccounts = _.sortBy groupedAccounts[type.toLowerCase()], 'path'
      typeTotal = _.reduce(typedAccounts, (sum, account) ->
        sum + account.value + account.children_value
      , 0)
      list.push {
        caption: type,
        balance: typeTotal,
        isHeader: true
      }

      # transform the accounts into display records
      _.each typedAccounts, (account) ->
        list.push {
          caption: account.name,
          balance: account.value + account.children_value,
          isHeader: false
        }

      list
    , []).value()
  return
]

app.directive 'accountManager', ->
  {
    restrict: 'E',
    templateUrl: '<%= asset_path('account-manager.html') %>'
  }
