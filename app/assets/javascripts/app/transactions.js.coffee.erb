app = angular.module 'transactions', []

app.controller 'TransactionFormController', ['$scope', '$uibModalInstance', '$http', ($scope, $uibModalInstance, $http) ->
  _self = this
  @_prepareData = ->
    transaction = $scope.formTransaction
    transaction.items_attributes = transaction.items
    transaction.items = null
    { transaction: transaction }
  @create = ->
    $http.post("/entities/#{$scope.currentEntityId}/transactions.json", _self._prepareData()).then null, (error) ->
      console.log "Unable to create the transaction."
      console.log error
  @update = ->
    $http.put("/transactions/#{$scope.formTransaction.id}.json", _self._prepareData()).then null, (error) ->
      console.log "Unable to update the transaction."
      console.log error
  $scope.save = ->
    if $scope.formTransaction.id
      _self.update().then (_) ->
        $uibModalInstance.close()
    else
      _self.create().then (_) ->
        $uibModalInstance.close()
  $scope.cancel = ->
    $uibModalInstance.dismiss('cancel')

  $scope.$watch ->
    return true unless $scope.formTransaction
    last = _.last($scope.formTransaction.items)
    if last then _.chain(last).pick('amount', 'account_id', 'action').isEmpty().value() else false
  , (isEmpty) ->
    return unless $scope.formTransaction && $scope.formTransaction.items
    $scope.formTransaction.items.push({}) unless isEmpty
]
