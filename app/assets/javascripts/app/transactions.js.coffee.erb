app = angular.module 'transactions', []

app.controller 'TransactionFormController', ['$scope', '$uibModalInstance', '$http', ($scope, $uibModalInstance, $http) ->
  _self = this
  $scope.transactionTotals = {debits: 0, credits: 0}
  @_prepareData = ->
    transaction = $scope.formTransaction
    transaction.items_attributes = transaction.items
    transaction.items = null
    { transaction: transaction }
  @create = ->
    $http.post("/entities/#{$scope.currentEntityId}/transactions.json", _self._prepareData()).then null, (error) ->
      console.log "Unable to create the transaction."
      console.log error
  @update = ->
    $http.put("/transactions/#{$scope.formTransaction.id}.json", _self._prepareData()).then null, (error) ->
      console.log "Unable to update the transaction."
      console.log error
  $scope.save = ->
    if $scope.formTransaction.id
      _self.update().then (_) ->
        $uibModalInstance.close()
    else
      _self.create().then (_) ->
        $uibModalInstance.close()
  $scope.cancel = ->
    $uibModalInstance.dismiss('cancel')

  # Recalculate total debits and total credits
  $scope.$watchCollection ->
    _.map(['debit', 'credit'], (a) -> _self._totalByAction(a))
  , (totals) ->
    $scope.transactionTotals.debits = totals[0]
    $scope.transactionTotals.credits = totals[1]
    $scope.transactionTotals.difference = totals[0] - totals[1]

  @_totalByAction = (action) ->
    _.chain($scope.formTransaction.items).filter( (i) ->
      i.action == action
    ).reduce( (sum, i) ->
      sum + i.amount
    , 0).value()

  # Ensure there is always an empty line item at the bottom of the list
  $scope.$watch ->
    return true unless $scope.formTransaction
    last = _.last($scope.formTransaction.items)
    if last then _.chain(last).pick('amount', 'account_id', 'action').isEmpty().value() else false
  , (isEmpty) ->
    return unless $scope.formTransaction && $scope.formTransaction.items
    $scope.formTransaction.items.push({}) unless isEmpty
]

app.controller('PurchasesController', ['$scope', ($scope) ->
  @newPurchase = { transactionDate: new Date() }
])

app.directive 'purchaseEntry', ->
  {
    restrict: 'E',
    templateUrl: '<%= asset_path('purchase-entry.html.haml') %>'
  }
