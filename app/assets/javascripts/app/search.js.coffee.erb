app = angular.module 'search', []

app.controller 'SearchController',
  ->
    _self = this
    @input = ""
    @matches = []
    @handlers = [
      new ManageEntitiesHandler(),
      new AddAccountHandler()
    ]
    @selected = null
    @execute = ->
      if @input && @input.length > 2
        matches = for handler in @handlers
          handler.handle(@input)
        _self.matches = matches.filter (m) -> !!m
      else
        _self.matches = []
    @select = (index) ->
      match = _self.matches[index]
      _self.selected = match.key
      _self.matches = []
      _self.input = ""
      return
    @isSelected = (key) ->
      _self.selected == key
    @selectFirst = (e) ->
      return unless e.keyCode == 13
      _self.select(0)
      return
    return

ManageEntitiesHandler = ->
  _self = this
  @handle = (input) ->
    re = RegExp(input, "i")
    isMatch = ["entity", "entities"].reduce (result, term) ->
      result || re.test(term)
    , false
    if isMatch
      return {description: "Manage entities", handler: _self, key: "entity-manager"}
    else
      return null
  return

AddAccountHandler = ->
  _self = this
  @handle = (input) ->
    re = RegExp(input, "i")
    if re.test("add")
      return {description: "Add account", handler: _self, key: "add-account"}
    else
      return null
  return
