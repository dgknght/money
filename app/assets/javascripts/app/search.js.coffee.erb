app = angular.module 'search', []

app.controller 'SearchController', ['$scope', '$http', ($scope, $http) ->
    _self = this
    @input = ""
    @matches = []
    @handlers = [
      new SimpleMatchingHandler('entity-manager', 'Manage entities', ['entity', 'entities']),
      new SimpleMatchingHandler('account-manager', 'Manage accounts', ['accounts']),
      new AccountMatchingHandler('account-register', 'Account register', $scope, $http)
    ]
    @selected = null
    @execute = ->
      if @input && @input.length > 2
        _self.matches = _.reduce(@handlers, (result, handler) ->
          result.concat handler.handle(_self.input)
        , [])
      else
        _self.matches = []
    @select = (index) ->
      match = _self.matches[index]
      $scope.selectedSearchHandler = match.key
      _self.matches = []
      _self.input = ""
      return
    @isSelected = (key) ->
      $scope.selectedSearchHandler == key
    @selectFirst = (e) ->
      return unless e.keyCode == 13
      _self.select(0)
      return
    return
]

class SimpleMatchingHandler
  constructor: (elementKey, description, matchingTerms) ->
    @elementKey = elementKey
    @description = description
    @matchingTerms = matchingTerms
  handle: (input) ->
    re = RegExp(input, "i")
    isMatch = @matchingTerms.reduce (result, term) ->
      result || re.test(term)
    ,false
    if isMatch
      [{description: @description, key: @elementKey}]
    else
      []

AccountMatchingHandler = (elementKey, descriptionTemplate, $scope, $http) ->
  _self = this
  @elementKey = elementKey
  @descriptionTemplate = descriptionTemplate
  @http = $http
  @accounts = []
  @entityId = null
  $scope.$watch 'currentEntity', (e) ->
    _self.loadAccounts(if e then e.id else null)

  @loadAccounts = (entityId) ->
    if entityId
      @http.get("/entities/#{entityId}/accounts.json").then( (response) ->
        _self.accounts= _.map(response.data, (a) -> { name: a.name, id: a.id })
      , (error) ->
        console.log "Unable to get the list of accounts for the matching handler"
        console.log error
      )
    else
      _self.accounts = []

  @handle = (input) ->
    re = new RegExp input, "i"
    _.reduce(@accounts, (result, a) ->
      result.push {description: a.name, key: @elementKey} if re.test(a.name)
      return result
    , [])

  return
